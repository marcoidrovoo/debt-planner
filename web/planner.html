<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Budget Dad ‚Äî Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Build your Budget Dad paycheck plan in minutes. Pay off debt and build savings." />
  <meta property="og:title" content="Budget Dad ‚Äî Planner" />
  <meta property="og:description" content="Plan your next paycheck with clear steps for income, bills, debt payoff, and savings goals." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#00bcd4" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="/site.webmanifest" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap");

    :root {
      --bg: #fff7ee;
      --bg-2: #eef7ff;
      --card: #ffffff;
      --card-2: #f7fbff;
      --muted: #4f5d6b;
      --text: #0a1220;
      --accent: #00bcd4;
      --accent-2: #ffb703;
      --accent-3: #ff6b6b;
      --border: #d8e2ef;
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.08);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --space-lg: 28px;
      --space-md: 20px;
      --space-sm: 14px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(0, 188, 212, 0.18), transparent 60%),
        radial-gradient(700px 520px at 82% 10%, rgba(255, 183, 3, 0.22), transparent 60%),
        radial-gradient(640px 480px at 50% 80%, rgba(255, 107, 107, 0.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg-2) 55%, #ffffff 100%);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
    }

    .page {
      display: flex;
      justify-content: center;
      padding: 56px 24px 96px;
    }

    .layout {
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-lg);
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(247, 249, 252, 0.95));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      animation: fadeUp 0.6s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .hero {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 32px;
      background:
        linear-gradient(135deg, rgba(0, 188, 212, 0.18), transparent 60%),
        linear-gradient(315deg, rgba(255, 183, 3, 0.18), transparent 50%),
        var(--card);
      border: 1px solid rgba(0, 188, 212, 0.25);
    }

    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 2.4vw, 2.4rem);
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 1.05rem;
      color: var(--muted);
      margin: 0;
    }

    .stepper {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .step {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0, 188, 212, 0.25);
      background: rgba(255, 255, 255, 0.8);
      color: var(--text);
      font-size: 0.85rem;
      font-weight: 600;
    }

    .section-title {
      font-size: 1.1rem;
      margin: 0 0 12px;
    }

    .section-desc {
      margin: 0 0 var(--space-md);
      color: var(--muted);
      font-size: 0.92rem;
    }

    .field { margin-bottom: var(--space-sm); }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: var(--text);
    }

    input, select, textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid #d3dbe6;
      background: #ffffff;
      color: var(--text);
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: rgba(0, 188, 212, 0.55);
      box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.12);
    }

    .button {
      width: 100%;
      padding: 13px 16px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 6px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b1120;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .button:hover { transform: translateY(-1px); box-shadow: 0 16px 36px rgba(0, 188, 212, 0.18); }
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .button.secondary {
      background: #ffffff;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .pill {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      margin-bottom: 8px;
    }

    .radio-row, .check-row {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.85);
    }
    .radio-row input, .check-row input { width: auto; }

    .field-inline { display: flex; gap: 12px; }
    .field-inline .field.small { flex: 1; }

    .muted { color: var(--muted); font-size: 0.85rem; }
    .hidden { display: none; }
    .note { font-size: 0.85rem; color: var(--muted); margin-top: 6px; }
    .divider { border: none; border-top: 1px solid rgba(148, 163, 184, 0.15); margin: 12px 0; }

    details {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.85);
      margin-top: 10px;
    }
    summary { cursor: pointer; font-weight: 700; }

    .result-box {
      margin-top: 12px;
      padding: 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.9);
      min-height: 60px;
      font-size: 0.95rem;
      color: var(--text);
    }

    .list {
      list-style: none;
      padding-left: 0;
      margin-top: 14px;
      font-size: 0.9rem;
    }

    .list li {
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      background: #ffffff;
      border: 1px solid var(--border);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .list-left { display: flex; flex-direction: column; gap: 2px; }
    .list-title { font-weight: 600; }
    .list-meta { color: var(--muted); font-size: 0.82rem; }

    .chip {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 188, 212, 0.35);
      background: rgba(0, 188, 212, 0.08);
      color: var(--text);
      font-size: 0.8rem;
      font-weight: 700;
    }

    .side-card {
      height: fit-content;
    }

    .mono {
      font-family: "DM Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.92rem;
    }

    .totals {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border: 1px dashed rgba(0, 188, 212, 0.35);
      border-radius: var(--radius-sm);
      margin-top: 8px;
      color: var(--muted);
    }

    .actions-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .tiny {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-size: 0.8rem;
      cursor: pointer;
    }
    .tiny:hover { border-color: rgba(0, 188, 212, 0.5); }

    .empty {
      padding: 12px;
      border-radius: var(--radius-sm);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      color: var(--muted);
      font-size: 0.9rem;
      text-align: center;
    }

    .toggle-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 6px;
    }
    .toggle-pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      cursor: pointer;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    .toggle-pill input { width: auto; }
    .toggle-pill.active {
      border-color: rgba(0, 188, 212, 0.45);
      box-shadow: 0 10px 22px rgba(0, 188, 212, 0.12);
    }

    .tooltip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--border);
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--muted);
      background: #ffffff;
      margin-left: 6px;
      position: relative;
      cursor: help;
    }
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: 135%;
      transform: translateX(-50%) translateY(0);
      background: #0a1220;
      color: #ffffff;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 0.75rem;
      width: max-content;
      max-width: 230px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 10;
    }
    .tooltip:hover::after,
    .tooltip:focus::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .plan-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      margin-top: 14px;
    }
    .plan-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px;
      background: rgba(255, 255, 255, 0.92);
    }
    .progress-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: #ffffff;
      margin-bottom: 10px;
    }
    .progress-head {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-weight: 600;
    }
    .progress-bar {
      height: 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      overflow: hidden;
    }
    .progress-bar span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      width: 0%;
      transition: width 0.4s ease;
    }
    .progress-meta {
      font-size: 0.82rem;
      color: var(--muted);
    }

    .topbar {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: var(--shadow);
    }
    .brand {
      font-weight: 700;
      letter-spacing: -0.02em;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .brand-badge {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #0b1120;
      font-weight: 800;
      font-size: 0.9rem;
    }
    .nav-links {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }
    .nav-links a { color: var(--muted); text-decoration: none; }
    .nav-links a:hover { color: var(--text); }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 20px;
      align-items: center;
    }
    .hero-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .hero-actions .button { width: auto; padding: 12px 18px; }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .stat {
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: #ffffff;
    }
    .stat h3 {
      margin: 0 0 4px;
      font-size: 1.1rem;
    }

    /* landing-only blocks removed on planner page */

    .onboard-modal {
      position: fixed;
      inset: 0;
      background: rgba(8, 13, 20, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 20;
    }
    .onboard-modal.active { display: flex; }
    .onboard-panel {
      width: min(720px, 100%);
      background: #ffffff;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 22px;
    }
    .onboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .onboard-progress {
      display: flex;
      gap: 6px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #dbe6f2;
    }
    .dot.active { background: var(--accent); }
    .onboard-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
    }
    .ghost {
      border: 1px solid var(--border);
      background: #ffffff;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }

    .faq {
      display: grid;
      gap: 10px;
    }
    .faq details {
      margin: 0;
      background: #ffffff;
    }

    .footer {
      margin-top: 12px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.85rem;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .footer a { color: var(--muted); text-decoration: none; }
    .footer a:hover { color: var(--text); text-decoration: underline; }

    .paywall-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(10, 18, 32, 0.55);
      z-index: 40;
      padding: 20px;
    }
    .paywall-modal.active { display: flex; }
    .paywall-panel {
      width: min(520px, 100%);
      background: #ffffff;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 24px;
      display: grid;
      gap: 14px;
    }
    .paywall-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .paywall-actions {
      display: grid;
      gap: 10px;
    }
    .paywall-actions .button { margin-top: 0; }
    .paywall-muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    /* Print / PDF export */
    @media print {
      body { background: #ffffff; }
      .page { padding: 0; }
      .hero, .section-desc, .stepper, .note, .muted { color: #111827 !important; }
      .card { box-shadow: none; border: 1px solid #d1d5db; }
      .button, .tiny, .pill, .check-row, .radio-row, .actions-row, .topbar, .paywall-modal { display: none !important; }
      .layout { grid-template-columns: 1fr; gap: 16px; }
      #plan-box { min-height: auto; }
      input, select { border: 1px solid #d1d5db; }
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .side-card { position: static; }
      .hero-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .field-inline { flex-direction: column; }
      .hero { padding: 22px; }
      .page { padding: 32px 16px 60px; }
      .topbar { flex-direction: column; gap: 8px; }
      .hero-actions { flex-direction: column; }
      .plan-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="page">
    <main class="layout">
      <div class="topbar" id="top">
        <div class="brand"><span class="brand-badge">BD</span> Budget Dad</div>
        <div class="nav-links">
          <a href="/">Home</a>
          <a href="#step1-title">Planner</a>
          <a href="/strategy">Debt Strategies</a>
        </div>
        <button class="ghost" type="button" onclick="openOnboarding()">Guided setup</button>
      </div>

      <section class="card hero">
        <div class="hero-grid">
          <div>
            <h1>Your paycheck plan starts here.</h1>
            <p class="subtitle">Follow the guided setup or jump straight into the planner.</p>
            <div class="hero-actions">
              <button class="button" type="button" onclick="openOnboarding()">Start guided setup</button>
              <a class="button secondary" href="#step1-title">Jump to planner</a>
            </div>
          </div>
          <div class="stat-row">
            <div class="stat">
              <h3>5 steps</h3>
              <div class="muted">Income ‚Üí Bills ‚Üí Debts ‚Üí Savings ‚Üí Plan</div>
            </div>
            <div class="stat">
              <h3>2 modes</h3>
              <div class="muted">Hourly or Salary, your choice</div>
            </div>
            <div class="stat">
              <h3>15 min</h3>
              <div class="muted">Typical full setup time</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="step1-title">
        <h2 class="section-title" id="step1-title">Step 1 ‚Äî Paycheck Setup</h2>
        <p class="section-desc">Build your net paycheck. We‚Äôll allocate bills, debt, and savings after.</p>

        <div class="field">
          <label>Pay type</label>
          <div class="pill">
            <label class="check-row" style="padding:6px 10px; background:transparent; border:none;">
              <input type="radio" name="pay-type" value="hourly" id="pay-type-hourly" checked />
              Hourly
            </label>
            <label class="check-row" style="padding:6px 10px; background:transparent; border:none;">
              <input type="radio" name="pay-type" value="salary" id="pay-type-salary" />
              Salary
            </label>
          </div>
          <div class="muted">Hourly supports overtime and variable hours.</div>
        </div>

        <div class="field">
          <label for="pay-frequency">Pay frequency</label>
          <select id="pay-frequency">
            <option value="">Select...</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Every 2 weeks</option>
          </select>
        </div>

        <!-- HOURLY SECTION -->
        <div id="hourly-section">
          <div class="field">
            <label for="hourly-rate">Hourly rate ($/hr)</label>
            <input id="hourly-rate" type="number" step="0.01" placeholder="e.g. 30" />
          </div>

          <div id="weekly-hours" class="field hidden">
            <label for="hours-week-1">Hours worked this week</label>
            <input id="hours-week-1" type="number" step="0.01" placeholder="e.g. 42" />
          </div>

          <div id="biweekly-hours" class="hidden">
            <div class="field-inline">
              <div class="field small">
                <label for="hours-week-1-bi">Week 1 hours</label>
                <input id="hours-week-1-bi" type="number" step="0.01" placeholder="e.g. 44" />
              </div>
              <div class="field small">
                <label for="hours-week-2-bi">Week 2 hours</label>
                <input id="hours-week-2-bi" type="number" step="0.01" placeholder="e.g. 40" />
              </div>
            </div>
          </div>

          <div class="field">
            <label>Overtime</label>
            <div class="check-row">
              <input id="ot-enabled" type="checkbox" checked />
              <div style="flex:1;">
                <div style="font-weight:700;">Overtime applies</div>
                <div class="muted">Auto-convert hours above threshold into OT (per week).</div>
              </div>
            </div>
          </div>

          <div id="ot-options">
            <div class="field-inline">
              <div class="field small">
                <label for="ot-threshold">OT starts after (hrs/week)</label>
                <input id="ot-threshold" type="number" step="0.01" value="40" />
              </div>
              <div class="field small">
                <label for="ot-multiplier">OT rate (multiplier)</label>
                <input id="ot-multiplier" type="number" step="0.01" value="1.5" />
              </div>
            </div>
          </div>

          <div class="field">
            <label for="extra-pay">Extra pay this paycheck ($) <span class="muted">(optional)</span></label>
            <input id="extra-pay" type="number" step="0.01" placeholder="e.g. 150" />
          </div>

          <div class="field">
            <label>Taxes</label>
            <div class="radio-row" style="margin-bottom:10px;">
              <input type="radio" name="tax-mode" value="estimate" id="tax-estimate" checked />
              <div style="flex:1;">
                <div style="font-weight:700;">Estimate my take-home</div>
                <div class="muted">Use a simple % you control.</div>
              </div>
            </div>

            <div id="tax-estimate-box" class="field-inline">
              <div class="field small">
                <label for="tax-rate">Estimated tax %</label>
                <input id="tax-rate" type="number" step="0.1" value="25" />
              </div>
              <div class="field small">
                <label for="net-preview" title="Auto-calculated net used by the plan">Net paycheck (preview)</label>
                <input id="net-preview" type="text" readonly />
              </div>
            </div>

            <div class="radio-row" style="margin:10px 0;">
              <input type="radio" name="tax-mode" value="exact" id="tax-exact" />
              <div style="flex:1;">
                <div style="font-weight:700;">I know my exact take-home</div>
                <div class="muted">Skip estimating taxes and just enter net.</div>
              </div>
            </div>

            <div id="tax-exact-box" class="field hidden">
              <label for="exact-net">Exact take-home (net) for this paycheck ($)</label>
              <input id="exact-net" type="number" step="0.01" placeholder="e.g. 2870" />
            </div>
          </div>
        </div>

        <!-- SALARY SECTION -->
        <div id="salary-section" class="hidden">
          <div class="field">
            <label for="salary-takehome">Take-home pay for this paycheck ($)</label>
            <input id="salary-takehome" type="number" step="0.01" placeholder="e.g. 2870" />
          </div>
          <div class="field">
            <label for="salary-extra-pay">Extra pay this paycheck ($) <span class="muted">(optional)</span></label>
            <input id="salary-extra-pay" type="number" step="0.01" placeholder="e.g. 150" />
          </div>
          <div class="muted">Salary mode assumes the number you enter is already net.</div>
        </div>

        <div class="field">
          <label for="starting-balance">Current bank balance right now ($)</label>
          <input id="starting-balance" type="number" placeholder="e.g. 2000" />
        </div>

        <div class="field">
          <label for="buffer">Minimum bank buffer you want to keep ($)</label>
          <input id="buffer" type="number" placeholder="e.g. 700" />
        </div>

        <div class="field">
          <label for="spending">Spending money per paycheck ($ for groceries, gas, fun)</label>
          <input id="spending" type="number" placeholder="e.g. 600" />
        </div>

        <div class="field">
          <label for="start-date">Start date for this plan (first paycheck you want to follow)</label>
          <input id="start-date" type="date" />
        </div>

        <button id="next-button" class="button">Save Step 1</button>

        <div id="step1-summary" class="result-box">
          üëá Fill Step 1, then click ‚ÄúSave Step 1‚Äù. Your net paycheck will appear here.
        </div>

        <details id="breakdown-details" class="hidden">
          <summary>Show paycheck breakdown</summary>
          <div id="breakdown-box" class="muted" style="margin-top:8px;"></div>
        </details>
      </section>

      <section class="card" aria-labelledby="step2-title">
        <h2 class="section-title" id="step2-title">Step 2 ‚Äî Fixed Bills</h2>
        <p class="section-desc">Add regular monthly bills like rent, HOA, car payments, or internet.</p>

        <div class="field">
          <label for="bill-name">Bill name</label>
          <input id="bill-name" type="text" placeholder="e.g. Mortgage" />
        </div>

        <div class="field-inline">
          <div class="field small">
            <label for="bill-amount">Amount ($)</label>
            <input id="bill-amount" type="number" placeholder="e.g. 2340" />
          </div>
          <div class="field small">
            <label for="bill-due-day">Due day of month</label>
            <input id="bill-due-day" type="number" min="1" max="31" placeholder="e.g. 16" />
          </div>
        </div>

        <button id="add-bill-button" class="button secondary">Add bill</button>
        <div class="totals">
          <span>Total bills tracked</span>
          <span class="mono" id="bills-total">$0.00</span>
        </div>
        <ul id="bills-list" class="list"></ul>
        <div id="bills-empty" class="empty hidden">No bills yet. Add your first bill above.</div>
        <div class="note">Tip: use ‚ÄúEdit‚Äù to update a bill or ‚ÄúRemove‚Äù to delete it.</div>
      </section>

      <section class="card" aria-labelledby="step3-title">
        <h2 class="section-title" id="step3-title">Step 3 ‚Äî Debts</h2>
        <p class="section-desc">Add credit cards or loans you want to pay down. Choose how you want extra payments prioritized.</p>

        <div class="field">
          <label for="debt-strategy">Debt payoff strategy</label>
          <select id="debt-strategy">
            <option value="snowball">Snowball (smallest balance first)</option>
            <option value="avalanche">Avalanche (highest APR first)</option>
          </select>
          <div class="muted">
            You can switch anytime ‚Äî the plan will update.
            <a href="/strategy">Learn the difference</a>
          </div>
        </div>

        <div class="field">
          <label for="debt-name">Debt name</label>
          <input id="debt-name" type="text" placeholder="e.g. Discover" />
        </div>

        <div class="field-inline">
          <div class="field small">
            <label for="debt-balance">Balance ($)</label>
            <input id="debt-balance" type="number" placeholder="e.g. 3200" />
          </div>
          <div class="field small">
            <label for="debt-minimum">Minimum payment ($)</label>
            <input id="debt-minimum" type="number" placeholder="e.g. 120" />
          </div>
        </div>

        <div class="field-inline">
          <div class="field small">
            <label for="debt-due-day">Minimum due day</label>
            <input id="debt-due-day" type="number" min="1" max="31" placeholder="e.g. 16" />
          </div>
          <div class="field small">
            <label for="debt-rate">Interest rate (%)</label>
            <input id="debt-rate" type="number" step="0.01" placeholder="e.g. 24.99" />
          </div>
        </div>

        <button id="add-debt-button" class="button secondary">Add debt</button>
        <div class="totals">
          <span>Minimums tracked</span>
          <span class="mono" id="debts-total">$0.00</span>
        </div>
        <ul id="debts-list" class="list"></ul>
        <div id="debts-empty" class="empty hidden">No debts yet. Add your first debt above.</div>
      </section>

      <section class="card" aria-labelledby="step4-title">
        <h2 class="section-title" id="step4-title">Step 4 ‚Äî Savings Goals</h2>
        <p class="section-desc">Build savings goals alongside debt payoff. Extra money is weighted by priority and deadline.</p>

        <div class="field">
          <label for="goal-type">Goal type</label>
          <select id="goal-type">
            <option value="Emergency Fund">Emergency Fund</option>
            <option value="Vacation">Vacation</option>
            <option value="House Down Payment">House Down Payment</option>
            <option value="Car">Car</option>
            <option value="Custom">Custom</option>
          </select>
        </div>

        <div class="field hidden" id="goal-name-field">
          <label for="goal-name">Goal name</label>
          <input id="goal-name" type="text" placeholder="e.g. Wedding Fund" />
        </div>

        <div class="field-inline">
          <div class="field small">
            <label for="goal-target">Target amount ($)</label>
            <input id="goal-target" type="number" placeholder="e.g. 5000" />
          </div>
          <div class="field small">
            <label for="goal-deadline">Deadline
              <span class="tooltip" tabindex="0" data-tooltip="Deadlines help the planner weight near-term goals more.">?</span>
            </label>
            <input id="goal-deadline" type="date" />
          </div>
        </div>

        <div class="field">
          <label for="goal-priority">Priority level
            <span class="tooltip" tabindex="0" data-tooltip="High priority + closer deadlines get a bigger slice of savings.">?</span>
          </label>
          <select id="goal-priority">
            <option value="high">High</option>
            <option value="medium" selected>Medium</option>
            <option value="low">Low</option>
          </select>
          <div class="muted">Priority and deadline work together to split savings automatically.</div>
        </div>

        <button id="add-goal-button" class="button secondary">Add goal</button>
        <div class="totals">
          <span>Total goal targets</span>
          <span class="mono" id="goals-total">$0.00</span>
        </div>
        <ul id="goals-list" class="list"></ul>
        <div id="goals-empty" class="empty hidden">No goals yet. Add your first goal above.</div>
        <div class="note">Tip: set close deadlines for urgent goals like emergency savings.</div>
      </section>

      <section class="card" aria-labelledby="step5-title">
        <h2 class="section-title" id="step5-title">Step 5 ‚Äî Plan Output</h2>
        <p class="section-desc">Calculate what to do with your next paycheck and share the summary.</p>
        <div class="field" style="margin-top:6px;">
          <label>Plan focus
            <span class="tooltip" tabindex="0" data-tooltip="Controls how extra cash is split after bills and minimums.">?</span>
          </label>
          <div class="toggle-group" id="focus-toggle">
            <label class="toggle-pill">
              <input type="radio" name="focus-mode" value="debt" id="focus-debt" />
              Focus on Debt
            </label>
            <label class="toggle-pill">
              <input type="radio" name="focus-mode" value="balanced" id="focus-balanced" checked />
              Balanced
            </label>
            <label class="toggle-pill">
              <input type="radio" name="focus-mode" value="saving" id="focus-saving" />
              Focus on Saving
            </label>
          </div>
          <div class="muted">Focus on Debt sends ~80% of extra to debt. Balanced is 50/50. Focus on Saving sends ~80% to goals.</div>
        </div>
        <div id="plan-box" class="result-box">
          üëá Click the button below to calculate what to do with your next paycheck.
        </div>
        <button id="calc-button" class="button">Calculate Plan</button>
        <button id="export-button" class="button secondary">Export Plan (PDF)</button>
        <button id="share-button" class="button secondary" disabled>Share Plan Summary</button>
        <div id="share-feedback" class="muted" role="status" aria-live="polite" style="margin-top:8px;"></div>
        <button id="onboarding-button" class="button secondary">Restart Onboarding</button>
        <button id="clear-button" class="button secondary">Clear Saved Data</button>
        <label class="check-row" style="margin-top:10px;">
          <input id="remember-data" type="checkbox" />
          <span style="flex:1;">Remember my data on this device</span>
        </label>
        <p class="muted" style="margin-top:8px;">Turn off to keep data only for this session.</p>
      </section>

      <section class="card" id="faq">
        <h2 class="section-title">FAQ</h2>
        <p class="section-desc">Common questions about the planner.</p>
        <div class="faq">
          <details>
            <summary>Where is my data stored?</summary>
            <div class="muted">Your data stays on your device (localStorage or sessionStorage). We don‚Äôt send it anywhere.</div>
          </details>
          <details>
            <summary>What if my pay varies?</summary>
            <div class="muted">Use hourly mode with your actual hours, or enter exact net pay for the paycheck.</div>
          </details>
          <details>
            <summary>Snowball vs avalanche?</summary>
            <div class="muted">Snowball targets the smallest balance for motivation. Avalanche targets the highest APR to save interest.</div>
          </details>
        </div>
      </section>

      <footer class="card footer">
        <span>¬© 2026 Budget Dad</span>
        <span>
          <a href="/">Home</a> ¬∑
          <a href="/privacy">Privacy</a> ¬∑
          <a href="/terms">Terms</a>
        </span>
      </footer>
    </main>
  </div>

  <div class="onboard-modal" id="onboard-modal" aria-hidden="true">
    <div class="onboard-panel">
      <div class="onboard-header">
        <div>
          <strong>Budget Dad ‚Äî Guided Setup</strong>
          <div class="muted">Answer a few questions to prefill your plan.</div>
        </div>
        <button class="ghost" type="button" onclick="closeOnboarding()">Close</button>
      </div>
      <div class="onboard-progress">
        <span class="dot" data-dot="0"></span>
        <span class="dot" data-dot="1"></span>
        <span class="dot" data-dot="2"></span>
      </div>

      <div class="onboard-step-page" data-step="0">
        <h3>Step 1 ‚Äî Pay type & frequency</h3>
        <div class="field">
          <label>Pay type</label>
          <div class="pill">
            <label class="check-row" style="padding:6px 10px; background:transparent; border:none;">
              <input type="radio" name="onboard-pay-type" value="hourly" checked />
              Hourly
            </label>
            <label class="check-row" style="padding:6px 10px; background:transparent; border:none;">
              <input type="radio" name="onboard-pay-type" value="salary" />
              Salary
            </label>
          </div>
        </div>
        <div class="field">
          <label for="onboard-frequency">Pay frequency</label>
          <select id="onboard-frequency">
            <option value="">Select...</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Every 2 weeks</option>
          </select>
        </div>
      </div>

      <div class="onboard-step-page hidden" data-step="1">
        <h3>Step 2 ‚Äî Debt strategy</h3>
        <div class="field">
          <label for="onboard-strategy">Which strategy do you want to try?</label>
          <select id="onboard-strategy">
            <option value="snowball">Snowball (smallest balance first)</option>
            <option value="avalanche">Avalanche (highest APR first)</option>
          </select>
        </div>
        <div class="field">
          <label for="onboard-start-date">Start date for this plan</label>
          <input id="onboard-start-date" type="date" />
        </div>
      </div>

      <div class="onboard-step-page hidden" data-step="2">
        <h3>Step 3 ‚Äî Buffer & spending</h3>
        <div class="field-inline">
          <div class="field small">
            <label for="onboard-buffer">Minimum buffer ($)</label>
            <input id="onboard-buffer" type="number" placeholder="e.g. 700" />
          </div>
          <div class="field small">
            <label for="onboard-spending">Spending per paycheck ($)</label>
            <input id="onboard-spending" type="number" placeholder="e.g. 600" />
          </div>
        </div>
        <div class="field">
          <label for="onboard-balance">Current bank balance ($)</label>
          <input id="onboard-balance" type="number" placeholder="e.g. 2000" />
        </div>
        <label class="check-row">
          <input id="onboard-remember" type="checkbox" checked />
          <span style="flex:1;">Remember my data on this device</span>
        </label>
      </div>

      <div class="onboard-actions">
        <button class="ghost" type="button" id="onboard-back">Back</button>
        <button class="button secondary" type="button" id="onboard-skip">Skip</button>
        <button class="button" type="button" id="onboard-next">Next</button>
      </div>
    </div>
  </div>

  <div class="paywall-modal" id="paywall-modal" aria-hidden="true">
    <div class="paywall-panel">
      <div class="paywall-header">
        <div>
          <strong>Unlock the full plan</strong>
          <div class="paywall-muted">Preview is ready ‚Äî subscribe to see the full plan.</div>
        </div>
        <button class="ghost" type="button" onclick="closePaywall()">Close</button>
      </div>
      <div class="card" style="padding:14px; background:var(--card-2); border:1px solid var(--border);">
        <div style="font-weight:700;">Budget Dad Pro</div>
        <div class="paywall-muted">Get the full plan, sharing, and PDF export.</div>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;">
          <span class="badge">$5 / month</span>
          <span class="badge">$50 / year (2 months free)</span>
        </div>
      </div>
      <div class="paywall-actions">
        <button class="button" type="button" onclick="startCheckout('monthly')">Start monthly ‚Äî $5/mo</button>
        <button class="button secondary" type="button" onclick="startCheckout('yearly')">Start yearly ‚Äî $50/yr</button>
        <button class="button secondary" type="button" onclick="startCheckout('demo')">I already subscribed</button>
      </div>
      <div class="paywall-muted">We don‚Äôt store your financial data. Cancel anytime.</div>
    </div>
  </div>

  <script>
    // =========================
    // Helpers
    // =========================
    function money(n) {
      const num = Number(n || 0);
      return num.toFixed(2);
    }
    function numVal(id) {
      return Number(document.getElementById(id).value || 0);
    }
    function strVal(id) {
      return String(document.getElementById(id).value || "").trim();
    }
    function parseLocalDate(dateStr) {
      // "YYYY-MM-DD" -> local midnight (no UTC shift)
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(y, m - 1, d);
    }
    function addDays(dateObj, days) {
      const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
      d.setDate(d.getDate() + days);
      return d;
    }
    function formatDateInput(dateObj) {
      const yyyy = dateObj.getFullYear();
      const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
      const dd = String(dateObj.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function formatMonthYear(dateObj) {
      if (!dateObj) return "‚Äî";
      return dateObj.toLocaleDateString(undefined, { month: "short", year: "numeric" });
    }
    function formatFullDate(dateObj) {
      if (!dateObj) return "‚Äî";
      return dateObj.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
    }
    let lastPlanSummary = null;
    function setShareReady(isReady) {
      const btn = document.getElementById("share-button");
      if (!btn) return;
      btn.disabled = !isReady;
    }
    function setShareFeedback(message) {
      const feedback = document.getElementById("share-feedback");
      if (feedback) feedback.textContent = message || "";
    }
    function getShareUrl() {
      if (window.location.origin && window.location.origin !== "null") {
        return `${window.location.origin}/planner`;
      }
      return window.location.href;
    }
    function buildShareText(details) {
      const summaryParts = [
        `Budget Dad plan (${details.rangeText}):`,
        `Bills $${money(details.billsThisCheck)}, minimums $${money(details.minsThisCheck)}, spending $${money(details.spendingPerCheck)}, buffer $${money(details.buffer)}.`
      ];

      if (details.extra <= 0) {
        summaryParts.push("No extra for additional debt or savings this paycheck.");
      } else {
        if (details.debtShare > 0 && details.targetDebtName) {
          summaryParts.push(`Extra $${money(details.debtShare)} to ${details.targetDebtName} (${details.strategyLabel}).`);
        } else if (details.debtShare > 0) {
          summaryParts.push(`Extra $${money(details.debtShare)} to debt (${details.strategyLabel}).`);
        }
        if (details.savingsShare > 0) {
          summaryParts.push(`Savings set aside $${money(details.savingsShare)} across goals.`);
        }
        if (details.debtShare <= 0 && details.savingsShare <= 0) {
          summaryParts.push(`Extra $${money(details.extra)} available after bills, minimums, and spending.`);
        }
      }

      return summaryParts.join(" ");
    }

    function lockPremiumActions(isLocked) {
      const exportButton = document.getElementById("export-button");
      const shareButton = document.getElementById("share-button");
      if (exportButton) exportButton.disabled = isLocked;
      if (shareButton) shareButton.disabled = isLocked || !lastPlanSummary;
      if (isLocked) {
        setShareFeedback("Unlock Pro to export or share your full plan.");
      }
    }
    function getNextPaycheckDate(startDateStr, frequency) {
      const start = parseLocalDate(startDateStr);
      if (frequency === "weekly") return addDays(start, 7);
      if (frequency === "biweekly") return addDays(start, 14);
      return addDays(start, 14);
    }

    // =========================
    // STEP 1: Paycheck Calc
    // =========================
    function setVisible(el, show) {
      el.classList.toggle("hidden", !show);
    }

    function getPayType() {
      return document.getElementById("pay-type-salary").checked ? "salary" : "hourly";
    }

    function updatePayTypeUI() {
      const type = getPayType();
      const freq = strVal("pay-frequency");

      setVisible(document.getElementById("hourly-section"), type === "hourly");
      setVisible(document.getElementById("salary-section"), type === "salary");

      // Hours blocks
      setVisible(document.getElementById("weekly-hours"), type === "hourly" && freq === "weekly");
      setVisible(document.getElementById("biweekly-hours"), type === "hourly" && freq === "biweekly");

      // OT options
      const otOn = document.getElementById("ot-enabled").checked;
      setVisible(document.getElementById("ot-options"), type === "hourly" && otOn);

      // Tax mode boxes
      const estimateOn = document.getElementById("tax-estimate").checked;
      setVisible(document.getElementById("tax-estimate-box"), type === "hourly" && estimateOn);
      setVisible(document.getElementById("tax-exact-box"), type === "hourly" && !estimateOn);

      // Preview net
      refreshNetPreview();
    }

    function calcWeek(hourlyRate, hours, otEnabled, otThreshold, otMultiplier) {
      const h = Number(hours || 0);
      let regularHours = h;
      let otHours = 0;

      if (otEnabled) {
        const thresh = Number(otThreshold || 40);
        if (h > thresh) {
          regularHours = thresh;
          otHours = h - thresh;
        }
      }

      const regPay = regularHours * hourlyRate;
      const otPay = otHours * hourlyRate * (otEnabled ? otMultiplier : 1);

      return {
        hours: h,
        regularHours,
        otHours,
        regPay,
        otPay,
        gross: regPay + otPay
      };
    }

    function calculateIncomeFromForm() {
      const payType = getPayType();
      const frequency = strVal("pay-frequency");
      const startDate = strVal("start-date");

      // Also store these from Step 1 section (bank/buffer/spending)
      const startingBalance = numVal("starting-balance");
      const buffer = numVal("buffer");
      const spending = numVal("spending");

      if (!frequency) {
        return { ok: false, message: "‚ö†Ô∏è Choose pay frequency first." };
      }
      if (!startDate) {
        return { ok: false, message: "‚ö†Ô∏è Choose a start date for the plan (first paycheck)." };
      }

      // SALARY
      if (payType === "salary") {
        const takeHome = numVal("salary-takehome");
        const extraPay = numVal("salary-extra-pay");
        const net = takeHome + extraPay;

        if (!takeHome || takeHome <= 0) {
          return { ok: false, message: "‚ö†Ô∏è Enter your salary take-home pay for this paycheck." };
        }

        return {
          ok: true,
          data: {
            payType,
            frequency,
            startDate,
            startingBalance,
            buffer,
            spending,
            payAmountForThisCheck: net, // NET used by plan
            debtStrategy: strVal("debt-strategy") || "snowball",
            breakdown: {
              mode: "salary",
              takeHome,
              extraPay,
              net
            }
          }
        };
      }

      // HOURLY
      const hourlyRate = numVal("hourly-rate");
      if (!hourlyRate || hourlyRate <= 0) {
        return { ok: false, message: "‚ö†Ô∏è Enter your hourly rate." };
      }

      // hours by frequency
      let week1Hours = 0;
      let week2Hours = 0;

      if (frequency === "weekly") {
        week1Hours = numVal("hours-week-1");
        if (week1Hours <= 0) return { ok: false, message: "‚ö†Ô∏è Enter hours worked this week." };
      } else if (frequency === "biweekly") {
        week1Hours = numVal("hours-week-1-bi");
        week2Hours = numVal("hours-week-2-bi");
        if (week1Hours <= 0 && week2Hours <= 0) return { ok: false, message: "‚ö†Ô∏è Enter hours for Week 1 and/or Week 2." };
      }

      const otEnabled = document.getElementById("ot-enabled").checked;
      const otThreshold = numVal("ot-threshold") || 40;
      const otMultiplier = numVal("ot-multiplier") || 1.5;
      const extraPay = numVal("extra-pay");

      // compute weeks
      const w1 = calcWeek(hourlyRate, week1Hours, otEnabled, otThreshold, otMultiplier);
      const w2 = calcWeek(hourlyRate, week2Hours, otEnabled, otThreshold, otMultiplier);

      const gross = w1.gross + w2.gross + extraPay;

      // tax mode
      const taxMode = document.getElementById("tax-exact").checked ? "exact" : "estimate";

      let taxRatePct = numVal("tax-rate");
      if (taxMode === "estimate" && (taxRatePct < 0 || taxRatePct > 60)) {
        return { ok: false, message: "‚ö†Ô∏è Tax % looks off. Use something like 20‚Äì35." };
      }

      let taxes = 0;
      let net = 0;

      if (taxMode === "exact") {
        const exactNet = numVal("exact-net");
        if (!exactNet || exactNet <= 0) return { ok: false, message: "‚ö†Ô∏è Enter your exact take-home net for this paycheck." };
        net = exactNet;
        taxes = null; // unknown (since user entered net)
      } else {
        taxes = gross * (taxRatePct / 100);
        net = gross - taxes;
      }

      return {
        ok: true,
        data: {
          payType,
          frequency,
          startDate,
          startingBalance,
          buffer,
          spending,
          payAmountForThisCheck: net, // NET used by plan
          debtStrategy: strVal("debt-strategy") || "snowball",
          breakdown: {
            mode: "hourly",
            hourlyRate,
            frequency,
            otEnabled,
            otThreshold,
            otMultiplier,
            week1: w1,
            week2: w2,
            extraPay,
            gross,
            taxMode,
            taxRatePct: taxMode === "estimate" ? taxRatePct : null,
            taxes,
            net
          }
        }
      };
    }

    function refreshNetPreview() {
      const payType = getPayType();
      const netPreview = document.getElementById("net-preview");

      if (payType !== "hourly") {
        netPreview.value = "";
        return;
      }

      const res = calculateIncomeFromForm();
      if (!res.ok) {
        netPreview.value = "";
        return;
      }

      const bd = res.data.breakdown;
      if (bd.mode !== "hourly") {
        netPreview.value = "";
        return;
      }

      netPreview.value = "$" + money(bd.net);
    }

    function renderStep1Summary(savedIncomeData) {
      const box = document.getElementById("step1-summary");
      const details = document.getElementById("breakdown-details");
      const breakdownBox = document.getElementById("breakdown-box");

      const net = savedIncomeData.payAmountForThisCheck;
      const bd = savedIncomeData.breakdown;

      box.innerHTML = `
        <span class="badge">Saved</span><br><br>
        <strong>Paycheck used for this plan (NET):</strong> $${money(net)}<br>
        <span class="muted">This is the number the planner uses for bills, debts, savings, and spending.</span>
      `;

      // breakdown html
      let html = "";

      if (bd.mode === "salary") {
        html = `
          <div><strong>Mode:</strong> Salary</div>
          <div><strong>Take-home entered:</strong> $${money(bd.takeHome)}</div>
          <div><strong>Extra pay:</strong> $${money(bd.extraPay)}</div>
          <div><strong>NET used:</strong> $${money(bd.net)}</div>
        `;
      } else {
        const w1 = bd.week1 || {};
        const w2 = bd.week2 || {};

        const week2Line = (bd.frequency === "biweekly")
          ? `
            <hr class="divider" style="margin:10px 0;">
            <div><strong>Week 2 hours:</strong> ${money(w2.hours)} hrs</div>
            <div class="muted">Regular: ${money(w2.regularHours)} hrs ‚Ä¢ OT: ${money(w2.otHours)} hrs</div>
            <div><strong>Week 2 pay:</strong> $${money(w2.gross)}</div>
          `
          : "";

        const taxesLine = (bd.taxMode === "estimate")
          ? `<div><strong>Estimated taxes (${bd.taxRatePct}%):</strong> $${money(bd.taxes)}</div>`
          : `<div><strong>Taxes:</strong> (skipped ‚Äî exact net entered)</div>`;

        html = `
          <div><strong>Mode:</strong> Hourly</div>
          <div><strong>Hourly rate:</strong> $${money(bd.hourlyRate)}/hr</div>
          <div><strong>OT enabled:</strong> ${bd.otEnabled ? "Yes" : "No"}</div>
          ${bd.otEnabled ? `<div class="muted">OT after ${money(bd.otThreshold)} hrs/week ‚Ä¢ OT rate ${money(bd.otMultiplier)}√ó</div>` : ""}

          <hr class="divider" style="margin:10px 0;">

          <div><strong>Week 1 hours:</strong> ${money(w1.hours)} hrs</div>
          <div class="muted">Regular: ${money(w1.regularHours)} hrs ‚Ä¢ OT: ${money(w1.otHours)} hrs</div>
          <div><strong>Week 1 pay:</strong> $${money(w1.gross)}</div>

          ${week2Line}

          <hr class="divider" style="margin:10px 0;">

          <div><strong>Extra pay:</strong> $${money(bd.extraPay)}</div>
          <div><strong>Gross total:</strong> $${money(bd.gross)}</div>
          ${taxesLine}
          <div><strong>NET used:</strong> $${money(bd.net)}</div>
        `;
      }

      breakdownBox.innerHTML = html;
      details.classList.remove("hidden");
    }

    // =========================
    // Storage (local or session)
    // =========================
    function getStorage() {
      const preferLocal = document.getElementById("remember-data")?.checked;
      return preferLocal ? window.localStorage : window.sessionStorage;
    }
    function saveDebtStrategy() {
      const strategy = strVal("debt-strategy") || "snowball";
      getStorage().setItem("debtStrategy", strategy);
    }
    function loadDebtStrategy() {
      const saved = getStorage().getItem("debtStrategy");
      return saved || null;
    }
    function syncStoragePreference() {
      const preferLocal = document.getElementById("remember-data")?.checked;
      window.localStorage.setItem("rememberData", preferLocal ? "yes" : "no");
      // Move data to the selected storage so behavior matches UI.
      const source = preferLocal ? window.sessionStorage : window.localStorage;
      const target = preferLocal ? window.localStorage : window.sessionStorage;
      ["incomeData", "billsData", "debtsData", "savingsGoalsData", "debtStrategy", "focusMode"].forEach(key => {
        const val = source.getItem(key);
        if (val) {
          target.setItem(key, val);
          source.removeItem(key);
        }
      });
    }
    function initStoragePreference() {
      const saved = window.localStorage.getItem("rememberData");
      const checkbox = document.getElementById("remember-data");
      if (!checkbox) return;
      checkbox.checked = saved !== "no";
    }

    // =========================
    // Metrics
    // =========================
    function trackEvent(name, props = {}) {
      const payload = { event: name, ...props };

      if (Array.isArray(window.dataLayer)) {
        window.dataLayer.push(payload);
      }
      if (typeof window.gtag === "function") {
        window.gtag("event", name, props);
      }

      try {
        const store = getStorage();
        const raw = store.getItem("bdMetrics");
        const metrics = raw ? JSON.parse(raw) : {};
        metrics[name] = (metrics[name] || 0) + 1;
        metrics._last = { name, props, at: new Date().toISOString() };
        store.setItem("bdMetrics", JSON.stringify(metrics));
      } catch (err) {
        // Ignore storage errors (private mode, full storage, etc.)
      }
    }

    // =========================
    // Onboarding
    // =========================
    let onboardStepIndex = 0;
    function setOnboardStep(index) {
      const steps = Array.from(document.querySelectorAll(".onboard-step-page"));
      const dots = Array.from(document.querySelectorAll(".dot"));
      onboardStepIndex = Math.max(0, Math.min(index, steps.length - 1));
      steps.forEach((el, i) => el.classList.toggle("hidden", i !== onboardStepIndex));
      dots.forEach((el, i) => el.classList.toggle("active", i === onboardStepIndex));
      document.getElementById("onboard-back").style.visibility = onboardStepIndex === 0 ? "hidden" : "visible";
      document.getElementById("onboard-next").textContent = onboardStepIndex === steps.length - 1 ? "Finish" : "Next";
    }

    function openOnboarding() {
      const modal = document.getElementById("onboard-modal");
      modal.classList.add("active");
      modal.setAttribute("aria-hidden", "false");
      const startInput = document.getElementById("onboard-start-date");
      if (startInput && !startInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        startInput.value = `${yyyy}-${mm}-${dd}`;
      }
      setOnboardStep(0);
    }

    function closeOnboarding() {
      const modal = document.getElementById("onboard-modal");
      modal.classList.remove("active");
      modal.setAttribute("aria-hidden", "true");
    }

    // =========================
    // Paywall
    // =========================
    function openPaywall() {
      const modal = document.getElementById("paywall-modal");
      modal.classList.add("active");
      modal.setAttribute("aria-hidden", "false");
    }
    function closePaywall() {
      const modal = document.getElementById("paywall-modal");
      modal.classList.remove("active");
      modal.setAttribute("aria-hidden", "true");
    }
    function startCheckout(plan) {
      trackEvent("paywall_clicked", { plan });
      if (plan === "demo") {
        getStorage().setItem("bdPro", "yes");
        closePaywall();
        lockPremiumActions(false);
        setShareFeedback("Pro unlocked on this device.");
        return;
      }
      alert("Checkout isn‚Äôt wired yet. Tell me your payment provider and I‚Äôll connect it.");
    }

    function applyOnboarding() {
      const payType = document.querySelector('input[name="onboard-pay-type"]:checked')?.value || "hourly";
      const frequency = strVal("onboard-frequency");
      const strategy = strVal("onboard-strategy") || "snowball";
      const startDate = strVal("onboard-start-date");
      const buffer = numVal("onboard-buffer");
      const spending = numVal("onboard-spending");
      const balance = numVal("onboard-balance");
      const remember = document.getElementById("onboard-remember").checked;

      document.getElementById("pay-type-hourly").checked = payType === "hourly";
      document.getElementById("pay-type-salary").checked = payType === "salary";
      if (frequency) document.getElementById("pay-frequency").value = frequency;
      if (startDate) document.getElementById("start-date").value = startDate;
      document.getElementById("debt-strategy").value = strategy;
      saveDebtStrategy();

      if (!Number.isNaN(buffer)) document.getElementById("buffer").value = buffer || "";
      if (!Number.isNaN(spending)) document.getElementById("spending").value = spending || "";
      if (!Number.isNaN(balance)) document.getElementById("starting-balance").value = balance || "";

      const rememberBox = document.getElementById("remember-data");
      rememberBox.checked = remember;
      syncStoragePreference();

      updatePayTypeUI();
      refreshNetPreview();
    }

    function saveIncome() {
      const result = calculateIncomeFromForm();
      const summaryBox = document.getElementById("step1-summary");

      if (!result.ok) {
        summaryBox.innerHTML = result.message;
        document.getElementById("breakdown-details").classList.add("hidden");
        return;
      }

      getStorage().setItem("incomeData", JSON.stringify(result.data));
      renderStep1Summary(result.data);
      summaryBox.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function loadIncome() {
      const storage = getStorage();
      const saved = storage.getItem("incomeData");
      if (!saved) return;
      const data = JSON.parse(saved);

      // shared fields
      if (data.frequency) document.getElementById("pay-frequency").value = data.frequency;
      if (data.startingBalance !== undefined) document.getElementById("starting-balance").value = data.startingBalance;
      if (data.buffer !== undefined) document.getElementById("buffer").value = data.buffer;
      if (data.spending !== undefined) document.getElementById("spending").value = data.spending;
      if (data.startDate) document.getElementById("start-date").value = data.startDate;

      // pay type + details
      if (data.payType === "salary") {
        document.getElementById("pay-type-salary").checked = true;
        document.getElementById("pay-type-hourly").checked = false;

        const bd = data.breakdown || {};
        document.getElementById("salary-takehome").value = bd.takeHome ?? data.payAmountForThisCheck ?? "";
        document.getElementById("salary-extra-pay").value = bd.extraPay ?? 0;
      } else {
        document.getElementById("pay-type-hourly").checked = true;
        document.getElementById("pay-type-salary").checked = false;

        const bd = data.breakdown || {};
        document.getElementById("hourly-rate").value = bd.hourlyRate ?? "";
        document.getElementById("ot-enabled").checked = bd.otEnabled ?? true;
        document.getElementById("ot-threshold").value = bd.otThreshold ?? 40;
        document.getElementById("ot-multiplier").value = bd.otMultiplier ?? 1.5;
        document.getElementById("extra-pay").value = bd.extraPay ?? 0;

        // hours
        if (data.frequency === "weekly") {
          document.getElementById("hours-week-1").value = bd.week1?.hours ?? "";
        } else if (data.frequency === "biweekly") {
          document.getElementById("hours-week-1-bi").value = bd.week1?.hours ?? "";
          document.getElementById("hours-week-2-bi").value = bd.week2?.hours ?? "";
        }

        // tax mode
        if (bd.taxMode === "exact") {
          document.getElementById("tax-exact").checked = true;
          document.getElementById("tax-estimate").checked = false;
          document.getElementById("exact-net").value = bd.net ?? data.payAmountForThisCheck ?? "";
        } else {
          document.getElementById("tax-estimate").checked = true;
          document.getElementById("tax-exact").checked = false;
          document.getElementById("tax-rate").value = bd.taxRatePct ?? 25;
        }
      }

      if (data.debtStrategy) {
        document.getElementById("debt-strategy").value = data.debtStrategy;
      }

      updatePayTypeUI();
      renderStep1Summary(data);
    }

    // =========================
    // Step 2: Bills
    // =========================
    let bills = [];

    function setEmptyState(id, show) {
      document.getElementById(id).classList.toggle("hidden", !show);
    }

    function getBillsData() {
      const saved = getStorage().getItem("billsData");
      return saved ? JSON.parse(saved) : [];
    }
    function saveBills() {
      getStorage().setItem("billsData", JSON.stringify(bills));
    }
    function renderBills() {
      const list = document.getElementById("bills-list");
      const totalEl = document.getElementById("bills-total");
      list.innerHTML = "";

      if (!bills.length) {
        setEmptyState("bills-empty", true);
        totalEl.textContent = "$0.00";
        return;
      }

      setEmptyState("bills-empty", false);

      const total = bills.reduce((sum, bill) => sum + Number(bill.amount || 0), 0);
      totalEl.textContent = "$" + money(total);

      bills.forEach((bill, index) => {
        const li = document.createElement("li");

        const left = document.createElement("div");
        left.className = "list-left";

        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = bill.name;

        const meta = document.createElement("div");
        meta.className = "list-meta";
        meta.textContent = `$${money(bill.amount)} ‚Ä¢ due ${bill.dueDay}`;

        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "actions-row";

        const editBtn = document.createElement("button");
        editBtn.className = "tiny";
        editBtn.type = "button";
        editBtn.textContent = "Edit";

        const removeBtn = document.createElement("button");
        removeBtn.className = "tiny";
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";

        li.appendChild(left);
        li.appendChild(right);

        right.appendChild(editBtn);
        right.appendChild(removeBtn);

        editBtn.addEventListener("click", () => {
          document.getElementById("bill-name").value = bill.name;
          document.getElementById("bill-amount").value = bill.amount;
          document.getElementById("bill-due-day").value = bill.dueDay;

          bills.splice(index, 1);
          saveBills();
          renderBills();
        });

        removeBtn.addEventListener("click", () => {
          bills.splice(index, 1);
          saveBills();
          renderBills();
        });

        list.appendChild(li);
      });
    }
    function addBill() {
      const name = strVal("bill-name");
      const amount = numVal("bill-amount");
      const dueDay = numVal("bill-due-day");

      if (!name || !amount || !dueDay) {
        alert("Please fill in all bill fields first.");
        return;
      }

      bills.push({ name, amount: Number(amount), dueDay: Number(dueDay) });
      saveBills();
      renderBills();

      document.getElementById("bill-name").value = "";
      document.getElementById("bill-amount").value = "";
      document.getElementById("bill-due-day").value = "";
    }
    function loadBills() {
      const saved = getStorage().getItem("billsData");
      if (!saved) {
        bills = [];
        renderBills();
        return;
      }
      bills = JSON.parse(saved);
      renderBills();
    }

    // =========================
    // Step 3: Debts
    // =========================
    let debts = [];

    function getDebtsData() {
      const saved = getStorage().getItem("debtsData");
      return saved ? JSON.parse(saved) : [];
    }
    function saveDebts() {
      getStorage().setItem("debtsData", JSON.stringify(debts));
    }
    function renderDebts() {
      const list = document.getElementById("debts-list");
      const totalEl = document.getElementById("debts-total");
      list.innerHTML = "";

      if (!debts.length) {
        setEmptyState("debts-empty", true);
        totalEl.textContent = "$0.00";
        return;
      }

      setEmptyState("debts-empty", false);

      const total = debts.reduce((sum, debt) => sum + Number(debt.minimum || 0), 0);
      totalEl.textContent = "$" + money(total);

      debts.forEach((debt, index) => {
        const li = document.createElement("li");

        const left = document.createElement("div");
        left.className = "list-left";

        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = debt.name;

        const meta = document.createElement("div");
        meta.className = "list-meta";
        meta.textContent = `$${money(debt.balance)} ‚Ä¢ min $${money(debt.minimum)} ‚Ä¢ due ${debt.dueDay} ‚Ä¢ ${money(debt.rate)}% APR`;

        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "actions-row";

        const editBtn = document.createElement("button");
        editBtn.className = "tiny";
        editBtn.type = "button";
        editBtn.textContent = "Edit";

        const removeBtn = document.createElement("button");
        removeBtn.className = "tiny";
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";

        li.appendChild(left);
        li.appendChild(right);

        right.appendChild(editBtn);
        right.appendChild(removeBtn);

        editBtn.addEventListener("click", () => {
          document.getElementById("debt-name").value = debt.name;
          document.getElementById("debt-balance").value = debt.balance;
          document.getElementById("debt-minimum").value = debt.minimum;
          document.getElementById("debt-rate").value = debt.rate;
          document.getElementById("debt-due-day").value = debt.dueDay;

          debts.splice(index, 1);
          saveDebts();
          renderDebts();
        });

        removeBtn.addEventListener("click", () => {
          debts.splice(index, 1);
          saveDebts();
          renderDebts();
        });

        list.appendChild(li);
      });
    }
    function addDebt() {
      const name = strVal("debt-name");
      const balance = numVal("debt-balance");
      const minimum = numVal("debt-minimum");
      const rate = numVal("debt-rate");
      const dueDay = numVal("debt-due-day");

      if (!name || !balance || !minimum || !rate || !dueDay) {
        alert("Please fill in all debt fields first (including due day).");
        return;
      }

      debts.push({ name, balance: Number(balance), minimum: Number(minimum), rate: Number(rate), dueDay: Number(dueDay) });
      saveDebts();
      renderDebts();

      document.getElementById("debt-name").value = "";
      document.getElementById("debt-balance").value = "";
      document.getElementById("debt-minimum").value = "";
      document.getElementById("debt-rate").value = "";
      document.getElementById("debt-due-day").value = "";
    }
    function loadDebts() {
      const saved = getStorage().getItem("debtsData");
      if (!saved) {
        debts = [];
        renderDebts();
        return;
      }
      debts = JSON.parse(saved);
      renderDebts();
    }
    function getTargetDebt(debts, strategy) {
      const active = debts.filter(debt => Number(debt.balance) > 0);
      if (!active.length) return null;
      if (strategy === "avalanche") {
        return active.slice().sort((a, b) => b.rate - a.rate)[0];
      }
      return active.slice().sort((a, b) => a.balance - b.balance)[0];
    }

    // =========================
    // Step 4: Savings Goals
    // =========================
    let savingsGoals = [];

    function getSavingsGoalsData() {
      const saved = getStorage().getItem("savingsGoalsData");
      return saved ? JSON.parse(saved) : [];
    }
    function saveSavingsGoals() {
      getStorage().setItem("savingsGoalsData", JSON.stringify(savingsGoals));
    }
    function updateGoalTypeUI() {
      const type = strVal("goal-type");
      const field = document.getElementById("goal-name-field");
      if (!field) return;
      setVisible(field, type === "Custom");
    }
    function renderSavingsGoals() {
      const list = document.getElementById("goals-list");
      const totalEl = document.getElementById("goals-total");
      list.innerHTML = "";

      if (!savingsGoals.length) {
        setEmptyState("goals-empty", true);
        totalEl.textContent = "$0.00";
        return;
      }

      setEmptyState("goals-empty", false);

      const total = savingsGoals.reduce((sum, goal) => sum + Number(goal.target || 0), 0);
      totalEl.textContent = "$" + money(total);

      savingsGoals.forEach((goal, index) => {
        const li = document.createElement("li");

        const left = document.createElement("div");
        left.className = "list-left";

        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = goal.name;

        const meta = document.createElement("div");
        meta.className = "list-meta";
        const deadlineText = goal.deadline ? formatFullDate(parseLocalDate(goal.deadline)) : "no deadline";
        meta.textContent = `$${money(goal.target)} ‚Ä¢ by ${deadlineText} ‚Ä¢ ${goal.priority} priority`;

        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "actions-row";

        const editBtn = document.createElement("button");
        editBtn.className = "tiny";
        editBtn.type = "button";
        editBtn.textContent = "Edit";

        const removeBtn = document.createElement("button");
        removeBtn.className = "tiny";
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";

        li.appendChild(left);
        li.appendChild(right);

        right.appendChild(editBtn);
        right.appendChild(removeBtn);

        editBtn.addEventListener("click", () => {
          document.getElementById("goal-type").value = goal.type || "Custom";
          updateGoalTypeUI();
          document.getElementById("goal-name").value = goal.type === "Custom" ? goal.name : "";
          document.getElementById("goal-target").value = goal.target;
          document.getElementById("goal-deadline").value = goal.deadline || "";
          document.getElementById("goal-priority").value = goal.priority || "medium";

          savingsGoals.splice(index, 1);
          saveSavingsGoals();
          renderSavingsGoals();
        });

        removeBtn.addEventListener("click", () => {
          savingsGoals.splice(index, 1);
          saveSavingsGoals();
          renderSavingsGoals();
        });

        list.appendChild(li);
      });
    }
    function addSavingsGoal() {
      const type = strVal("goal-type");
      const customName = strVal("goal-name");
      const target = numVal("goal-target");
      const deadline = strVal("goal-deadline");
      const priority = strVal("goal-priority") || "medium";

      const name = type === "Custom" ? customName : type;

      if (!name || !target || !deadline || !priority) {
        alert("Please fill in all savings goal fields first.");
        return;
      }

      savingsGoals.push({
        type,
        name,
        target: Number(target),
        deadline,
        priority
      });
      saveSavingsGoals();
      renderSavingsGoals();

      document.getElementById("goal-name").value = "";
      document.getElementById("goal-target").value = "";
      document.getElementById("goal-deadline").value = "";
      document.getElementById("goal-priority").value = "medium";
    }
    function loadSavingsGoals() {
      const saved = getStorage().getItem("savingsGoalsData");
      if (!saved) {
        savingsGoals = [];
        renderSavingsGoals();
        return;
      }
      savingsGoals = JSON.parse(saved);
      renderSavingsGoals();
    }

    // =========================
    // Window logic for bills/minimums
    // =========================
    function getDueItemsInWindow(startDateStr, endDateObj, items, amountKey) {
      const start = parseLocalDate(startDateStr);
      const end = endDateObj;

      const startDay = start.getDate();
      const endDay = end.getDate();

      const crossesMonth =
        start.getMonth() !== end.getMonth() || start.getFullYear() !== end.getFullYear();

      const dueItems = items.filter(item => {
        const d = Number(item.dueDay);
        if (!d) return false;

        // include start day, exclude end day
        if (!crossesMonth) {
          return d >= startDay && d < endDay;
        } else {
          return d >= startDay || d < endDay;
        }
      });

      const total = dueItems.reduce((sum, item) => sum + Number(item[amountKey] || 0), 0);

      const rangeText = crossesMonth
        ? `${start.toLocaleDateString()} ‚Üí ${end.toLocaleDateString()} (crosses month)`
        : `${start.toLocaleDateString()} ‚Üí ${end.toLocaleDateString()}`;

      return { dueItems, total, rangeText };
    }

    function getFocusMode() {
      return document.querySelector('input[name="focus-mode"]:checked')?.value
        || loadFocusMode()
        || "balanced";
    }
    function saveFocusMode(mode) {
      getStorage().setItem("focusMode", mode);
    }
    function loadFocusMode() {
      return getStorage().getItem("focusMode");
    }
    function setFocusModeUI(mode) {
      const targetId = mode === "debt" ? "focus-debt" : mode === "saving" ? "focus-saving" : "focus-balanced";
      const input = document.getElementById(targetId);
      if (input) input.checked = true;
      updateFocusToggleStyles();
    }
    function updateFocusToggleStyles() {
      document.querySelectorAll("#focus-toggle .toggle-pill").forEach(label => {
        const input = label.querySelector("input");
        label.classList.toggle("active", Boolean(input?.checked));
      });
    }
    function getFocusSplit(mode, hasDebts, hasGoals) {
      if (!hasDebts && !hasGoals) return { debtRatio: 0, savingsRatio: 0 };
      if (!hasDebts) return { debtRatio: 0, savingsRatio: 1 };
      if (!hasGoals) return { debtRatio: 1, savingsRatio: 0 };
      if (mode === "debt") return { debtRatio: 0.8, savingsRatio: 0.2 };
      if (mode === "saving") return { debtRatio: 0.2, savingsRatio: 0.8 };
      return { debtRatio: 0.5, savingsRatio: 0.5 };
    }
    function priorityWeight(priority) {
      if (priority === "high") return 1.4;
      if (priority === "low") return 0.85;
      return 1.1;
    }
    function deadlineUrgencyWeight(deadlineDate, currentDate) {
      if (!deadlineDate || Number.isNaN(deadlineDate.getTime())) return 1;
      const days = (deadlineDate - currentDate) / (1000 * 60 * 60 * 24);
      if (days <= 0) return 2;
      const months = days / 30;
      return 1 + Math.max(0, (12 - months)) / 12;
    }
    function goalWeight(goal, currentDate) {
      return priorityWeight(goal.priority) * deadlineUrgencyWeight(goal.deadlineDate, currentDate);
    }
    function mergeAllocationMaps(base, add) {
      Object.entries(add).forEach(([key, value]) => {
        base[key] = (base[key] || 0) + value;
      });
    }
    function applyExtraToDebts(debts, amount, strategy) {
      const allocations = {};
      let remaining = amount;
      let guard = 0;

      while (remaining > 0.01 && debts.some(debt => debt.balance > 0) && guard < 200) {
        const target = getTargetDebt(debts, strategy);
        if (!target) break;
        const pay = Math.min(remaining, target.balance);
        target.balance -= pay;
        allocations[target.name] = (allocations[target.name] || 0) + pay;
        remaining -= pay;
        guard += 1;
      }

      return { allocations, remaining };
    }
    function allocateSavings(goals, amount, currentDate) {
      const allocations = {};
      let remaining = amount;
      let guard = 0;
      let active = goals.filter(goal => goal.saved < goal.target);

      while (remaining > 0.01 && active.length && guard < 20) {
        const totalWeight = active.reduce((sum, goal) => sum + goalWeight(goal, currentDate), 0);
        let usedThisRound = 0;

        active.forEach(goal => {
          const weight = totalWeight ? goalWeight(goal, currentDate) : 0;
          const share = totalWeight ? remaining * (weight / totalWeight) : 0;
          const cap = goal.target - goal.saved;
          const allocation = Math.min(share, cap);
          if (allocation > 0) {
            goal.saved += allocation;
            allocations[goal.name] = (allocations[goal.name] || 0) + allocation;
            usedThisRound += allocation;
          }
        });

        if (usedThisRound <= 0) break;
        remaining -= usedThisRound;
        active = goals.filter(goal => goal.saved < goal.target);
        guard += 1;
      }

      return { allocations, remaining };
    }
    function calculateAllocationForCheck(extra, debts, goals, strategy, focusMode, currentDate) {
      const hasDebts = debts.some(debt => debt.balance > 0);
      const hasGoals = goals.length > 0;
      const split = getFocusSplit(focusMode, hasDebts, hasGoals);
      let debtPool = extra * split.debtRatio;
      let savingsPool = extra * split.savingsRatio;

      const debtClone = debts.map(debt => ({
        ...debt,
        balance: Number(debt.balance)
      }));
      const goalsClone = goals.map(goal => ({
        ...goal,
        target: Number(goal.target),
        saved: 0,
        deadlineDate: goal.deadline ? parseLocalDate(goal.deadline) : null
      }));

      const debtAlloc = applyExtraToDebts(debtClone, debtPool, strategy);
      const debtAllocations = { ...debtAlloc.allocations };

      if (debtAlloc.remaining > 0 && hasGoals) {
        savingsPool += debtAlloc.remaining;
      }

      const savingsAlloc = allocateSavings(goalsClone, savingsPool, currentDate);
      const savingsAllocations = { ...savingsAlloc.allocations };

      if (savingsAlloc.remaining > 0 && hasDebts) {
        const extraDebtAlloc = applyExtraToDebts(debtClone, savingsAlloc.remaining, strategy);
        mergeAllocationMaps(debtAllocations, extraDebtAlloc.allocations);
      }

      const debtExtra = Object.values(debtAllocations).reduce((sum, amt) => sum + amt, 0);
      const savingsExtra = Object.values(savingsAllocations).reduce((sum, amt) => sum + amt, 0);

      return { debtAllocations, savingsAllocations, debtExtra, savingsExtra, split };
    }
    function simulateProjection(income, bills, debts, goals, strategy, focusMode) {
      if (!income) return null;
      const payAmount = Number(income.payAmountForThisCheck || 0);
      const frequency = income.frequency;
      const buffer = Number(income.buffer) || 0;
      const spending = Number(income.spending) || 0;
      const startingBalance = Number(income.startingBalance) || 0;
      const startDateStr = income.startDate;

      if (!payAmount || !frequency || !startDateStr) return null;

      const payDays = frequency === "weekly" ? 7 : 14;
      const maxIterations = frequency === "weekly" ? 520 : 260;

      let currentStart = parseLocalDate(startDateStr);
      let currentBalance = startingBalance;

      const simDebts = debts.map(debt => ({
        ...debt,
        balance: Number(debt.balance)
      }));
      const simGoals = goals.map(goal => ({
        ...goal,
        target: Number(goal.target),
        saved: 0,
        deadlineDate: goal.deadline ? parseLocalDate(goal.deadline) : null,
        completedDate: null,
        amountAtDeadline: null
      }));

      let debtFreeDate = null;
      let noProgressStreak = 0;
      let lastRemaining = simDebts.reduce((sum, debt) => sum + Math.max(0, debt.balance), 0)
        + simGoals.reduce((sum, goal) => sum + Math.max(0, goal.target - goal.saved), 0);
      let lastEndDate = currentStart;

      for (let i = 0; i < maxIterations; i += 1) {
        const endDate = addDays(currentStart, payDays);
        lastEndDate = endDate;

        const startStr = formatDateInput(currentStart);
        const billsWindow = getDueItemsInWindow(startStr, endDate, bills, "amount");
        const activeDebts = simDebts.filter(debt => debt.balance > 0);
        const debtWindow = getDueItemsInWindow(startStr, endDate, activeDebts, "minimum");
        const minsThisCheck = debtWindow.dueItems.reduce((sum, debt) => sum + Math.min(debt.minimum, debt.balance), 0);

        debtWindow.dueItems.forEach(debt => {
          const pay = Math.min(debt.minimum, debt.balance);
          debt.balance -= pay;
        });

        const totalAvailable = payAmount + currentBalance;
        const required = billsWindow.total + minsThisCheck + spending + buffer;
        let extra = totalAvailable - required;
        if (extra < 0) extra = 0;

        const hasDebts = simDebts.some(debt => debt.balance > 0);
        const hasGoals = simGoals.some(goal => goal.saved < goal.target);
        const split = getFocusSplit(focusMode, hasDebts, hasGoals);

        let debtPool = extra * split.debtRatio;
        let savingsPool = extra * split.savingsRatio;

        const debtAlloc = applyExtraToDebts(simDebts, debtPool, strategy);
        if (debtAlloc.remaining > 0 && hasGoals) {
          savingsPool += debtAlloc.remaining;
        }

        const savingsAlloc = allocateSavings(simGoals, savingsPool, currentStart);
        if (savingsAlloc.remaining > 0 && hasDebts) {
          applyExtraToDebts(simDebts, savingsAlloc.remaining, strategy);
        }

        if (!debtFreeDate && !simDebts.some(debt => debt.balance > 0)) {
          debtFreeDate = endDate;
        }

        simGoals.forEach(goal => {
          if (!goal.completedDate && goal.saved >= goal.target - 0.01) {
            goal.saved = goal.target;
            goal.completedDate = endDate;
          }
          if (goal.amountAtDeadline === null && goal.deadlineDate && endDate >= goal.deadlineDate) {
            goal.amountAtDeadline = Math.min(goal.saved, goal.target);
          }
        });

        if (totalAvailable >= required) {
          currentBalance = buffer;
        } else {
          currentBalance = totalAvailable - billsWindow.total - minsThisCheck - spending;
        }

        const remaining = simDebts.reduce((sum, debt) => sum + Math.max(0, debt.balance), 0)
          + simGoals.reduce((sum, goal) => sum + Math.max(0, goal.target - goal.saved), 0);

        if (Math.abs(remaining - lastRemaining) < 0.01) {
          noProgressStreak += 1;
        } else {
          noProgressStreak = 0;
        }
        lastRemaining = remaining;

        if (!simDebts.some(debt => debt.balance > 0) && !simGoals.some(goal => goal.saved < goal.target)) {
          break;
        }

        if (noProgressStreak >= 6) {
          break;
        }

        currentStart = endDate;
      }

      simGoals.forEach(goal => {
        if (goal.amountAtDeadline === null) {
          goal.amountAtDeadline = Math.min(goal.saved, goal.target);
        }
      });

      return {
        debtFreeDate,
        goals: simGoals,
        stalled: noProgressStreak >= 6,
        lastDate: lastEndDate
      };
    }

    // =========================
    // Plan
    // =========================
    function getIncomeData() {
      const saved = getStorage().getItem("incomeData");
      return saved ? JSON.parse(saved) : null;
    }

    function calculatePlanUI() {
      const box = document.getElementById("plan-box");
      setShareReady(false);
      setShareFeedback("");
      lastPlanSummary = null;

      const income = getIncomeData();
      const bills = getBillsData();
      const debts = getDebtsData();
      const goals = getSavingsGoalsData();
      const focusMode = getFocusMode();
      saveFocusMode(focusMode);
      updateFocusToggleStyles();

      const strategySelect = document.getElementById("debt-strategy");
      const storedStrategy = loadDebtStrategy();
      const strategy = strVal("debt-strategy") || storedStrategy || income?.debtStrategy || "snowball";
      if (strategySelect) {
        strategySelect.value = strategy;
      }

      if (!income) {
        box.innerHTML = "‚ö†Ô∏è Add your income first, then click Save Step 1.";
        return;
      }

      const payAmount = Number(income.payAmountForThisCheck || 0); // NET
      const frequency = income.frequency;
      const startingBalance = Number(income.startingBalance) || 0;
      const buffer = Number(income.buffer) || 0;
      const spendingPerCheck = Number(income.spending) || 0;
      const startDateStr = income.startDate;

      if (!payAmount || !frequency) {
        box.innerHTML = "‚ö†Ô∏è Please complete Step 1 and save it.";
        return;
      }
      if (!startDateStr) {
        box.innerHTML = "‚ö†Ô∏è Please choose a start date for the plan (first paycheck).";
        return;
      }

      const start = parseLocalDate(startDateStr);
      const startDateText = start.toLocaleDateString();

      const nextPayDate = getNextPaycheckDate(startDateStr, frequency);
      const nextPayDateText = nextPayDate.toLocaleDateString();
      const shareRangeText = `${startDateText} ‚Üí ${nextPayDateText}`;
      const strategyLabel = strategy === "avalanche"
        ? "Avalanche (highest APR first)"
        : "Snowball (smallest balance first)";

      const focusLabel = focusMode === "debt"
        ? "Focus on Debt"
        : focusMode === "saving"
          ? "Focus on Saving"
          : "Balanced";

      // window totals
      const billsWindow = getDueItemsInWindow(startDateStr, nextPayDate, bills, "amount");
      const billsThisCheck = billsWindow.total;
      const dueBills = billsWindow.dueItems;
      const rangeText = billsWindow.rangeText;

      const debtWindow = getDueItemsInWindow(startDateStr, nextPayDate, debts, "minimum");
      const minsThisCheck = debtWindow.total;
      const dueMinDebts = debtWindow.dueItems;

      const billsListHtml = dueBills.length
        ? "<ul>" + dueBills.map(b => `<li>${b.name}: $${money(b.amount)} (due ${b.dueDay})</li>`).join("") + "</ul>"
        : "No bills due in this window. üéâ";

      const minsListHtml = dueMinDebts.length
        ? "<ul>" + dueMinDebts.map(d => `<li>${d.name}: $${money(d.minimum)} (due ${d.dueDay})</li>`).join("") + "</ul>"
        : "No minimum payments due in this window. üéâ";

      // available cash
      const totalAvailable = payAmount + startingBalance;

      const neededForBillsAndSpending = billsThisCheck + minsThisCheck + spendingPerCheck + buffer;
      const extraRaw = totalAvailable - neededForBillsAndSpending;
      const extra = Math.max(0, extraRaw);

      const hasDebts = debts.length > 0;
      const hasGoals = goals.length > 0;

      let allocation = {
        debtAllocations: {},
        savingsAllocations: {},
        debtExtra: 0,
        savingsExtra: 0,
        split: { debtRatio: 0, savingsRatio: 0 }
      };

      if (extra > 0 && (hasDebts || hasGoals)) {
        allocation = calculateAllocationForCheck(extra, debts, goals, strategy, focusMode, start);
      }

      const targetDebt = getTargetDebt(debts, strategy);
      const endBalance = totalAvailable >= neededForBillsAndSpending
        ? buffer
        : totalAvailable - billsThisCheck - minsThisCheck - spendingPerCheck;

      const debtExtraListHtml = Object.keys(allocation.debtAllocations).length
        ? "<ul>" + Object.entries(allocation.debtAllocations).map(([name, amt]) => `<li>${name}: $${money(amt)}</li>`).join("") + "</ul>"
        : "No extra debt payments this paycheck.";

      const savingsAllocListHtml = Object.keys(allocation.savingsAllocations).length
        ? "<ul>" + Object.entries(allocation.savingsAllocations).map(([name, amt]) => `<li>${name}: $${money(amt)}</li>`).join("") + "</ul>"
        : "No savings contributions this paycheck.";

      const projection = simulateProjection(income, bills, debts, goals, strategy, focusMode);
      const projectionNote = projection?.stalled
        ? "Projection paused ‚Äî there‚Äôs no extra after bills, minimums, spending, and buffer."
        : "Projection assumes the same paycheck, bills, and minimums each cycle and ignores interest.";

      const debtFreeText = !hasDebts
        ? "No debts tracked."
        : projection?.debtFreeDate
          ? formatMonthYear(projection.debtFreeDate)
          : "Not reachable yet";

      const goalProjectionRows = projection && projection.goals?.length
        ? projection.goals.map(goal => {
          const deadlineDate = goal.deadlineDate && !Number.isNaN(goal.deadlineDate.getTime()) ? goal.deadlineDate : null;
          const deadlineText = deadlineDate ? formatMonthYear(deadlineDate) : "no deadline";
          const completionText = goal.completedDate ? formatMonthYear(goal.completedDate) : "Not reached yet";
          const afterDeadline = goal.completedDate && deadlineDate && goal.completedDate > deadlineDate;
          const amountAtDeadline = goal.amountAtDeadline ?? 0;
          const percentAtDeadline = goal.target > 0
            ? Math.min(100, Math.round((amountAtDeadline / goal.target) * 100))
            : 0;
          const thisCheckSaved = allocation.savingsAllocations[goal.name] || 0;
          return `
            <div class="progress-row">
              <div class="progress-head">
                <span>${goal.name}</span>
                <span class="mono">$${money(goal.target)}</span>
              </div>
              <div class="progress-bar"><span style="width:${percentAtDeadline}%"></span></div>
              <div class="progress-meta">
                Projected ${percentAtDeadline}% by ${deadlineText} ‚Ä¢ Completion ${completionText}${afterDeadline ? " (after deadline)" : ""} ‚Ä¢ This paycheck $${money(thisCheckSaved)}
              </div>
            </div>
          `;
        }).join("")
        : `<div class="muted">No savings goals yet. Add one in Step 4.</div>`;

      const debtRowsHtml = debts.length
        ? debts.map(debt => `
          <div class="progress-row">
            <div class="progress-head">
              <span>${debt.name}</span>
              <span class="mono">$${money(debt.balance)}</span>
            </div>
            <div class="progress-meta">Minimum $${money(debt.minimum)} ‚Ä¢ Due ${debt.dueDay} ‚Ä¢ ${money(debt.rate)}% APR</div>
          </div>
        `).join("")
        : `<div class="muted">No debts tracked. Add one in Step 3.</div>`;

      const planGridHtml = `
        <div class="plan-grid">
          <div class="plan-card">
            <strong>Debts</strong>
            <div class="muted" style="margin-top:4px;">Balances and minimums.</div>
            ${debtRowsHtml}
          </div>
          <div class="plan-card">
            <strong>Savings goals</strong>
            <div class="muted" style="margin-top:4px;">Progress bars show projected progress by deadline.</div>
            ${goalProjectionRows}
          </div>
        </div>
      `;

      lastPlanSummary = {
        text: buildShareText({
          rangeText: shareRangeText,
          billsThisCheck,
          minsThisCheck,
          spendingPerCheck,
          buffer,
          extra,
          targetDebtName: targetDebt?.name || null,
          strategyLabel,
          debtShare: allocation.debtExtra || 0,
          savingsShare: allocation.savingsExtra || 0
        }),
        url: getShareUrl()
      };
      setShareReady(true);

      const proUnlocked = getStorage().getItem("bdPro") === "yes";
      if (!proUnlocked) {
        box.innerHTML = `
          <strong>Plan preview:</strong> ${extra <= 0 ? "This paycheck is fully allocated." : "You have extra available this paycheck."}<br>
          <div class="muted" style="margin-top:8px;">
            Available: $${money(totalAvailable)} ‚Ä¢ Bills: $${money(billsThisCheck)} ‚Ä¢ Minimums: $${money(minsThisCheck)} ‚Ä¢ Spending: $${money(spendingPerCheck)} ‚Ä¢ Buffer: $${money(buffer)}
          </div>
          ${extra > 0 ? `<div class="muted" style="margin-top:6px;">Extra remaining: $${money(extra)}.</div>` : ""}
          <div class="muted" style="margin-top:6px;">
            Unlock Pro to see the full plan details, export, and share.
          </div>
        `;
        lockPremiumActions(true);
        openPaywall();
        return;
      }

      lockPremiumActions(false);

      if (extra <= 0) {
        box.innerHTML = `
          <strong>Paycheck used (NET):</strong> $${money(payAmount)}<br>
          <strong>Current bank balance:</strong> $${money(startingBalance)}<br>
          <strong>Total available (balance + paycheck):</strong> $${money(totalAvailable)}<br>
          <strong>Target buffer to keep:</strong> $${money(buffer)}<br><br>

          <strong>This paycheck date:</strong> ${startDateText}<br>
          <strong>Window:</strong> ${rangeText}<br><br>

          <strong>Bills due this window:</strong> $${money(billsThisCheck)}<br>
          <strong>Debt minimums due this window:</strong> $${money(minsThisCheck)}<br>
          <strong>Spending money this paycheck:</strong> $${money(spendingPerCheck)}<br><br>

          <strong>Bills to pay now:</strong><br>
          ${billsListHtml}<br><br>

          <strong>Minimum payments due this paycheck:</strong><br>
          ${minsListHtml}<br><br>

          ‚ö†Ô∏è If you pay all of this and keep your buffer of $${money(buffer)},
          you don‚Äôt have extra for additional debt or savings this paycheck.<br>
          Estimated bank balance after following this plan: $${money(endBalance)}.<br><br>
          ${planGridHtml}
          <div style="margin-top:14px;">
            <strong>Monthly projection</strong>
            <div class="muted" style="margin-top:6px;">Debt-free date: ${debtFreeText}</div>
            ${projection?.goals?.length ? projection.goals.map(goal => `<div class="muted">${goal.name}: ${goal.completedDate ? formatMonthYear(goal.completedDate) : "Not reached yet"}</div>`).join("") : ""}
            <div class="muted" style="margin-top:6px;">${projectionNote}</div>
          </div>
        `;
        return;
      }

      if (!hasDebts && !hasGoals) {
        box.innerHTML = `
          You have about <strong>$${money(extra)}</strong> left this paycheck
          after bills, minimums, and spending money. Add at least one debt or savings goal to aim this at.
        `;
        return;
      }

      box.innerHTML = `
        <strong>Paycheck used (NET):</strong> $${money(payAmount)}<br>
        <strong>Current bank balance:</strong> $${money(startingBalance)}<br>
        <strong>Total available (balance + paycheck):</strong> $${money(totalAvailable)}<br>
        <strong>Target buffer to keep:</strong> $${money(buffer)}<br><br>

        <strong>This paycheck date:</strong> ${startDateText}<br>
        <strong>Window:</strong> ${rangeText}<br><br>

        <strong>Bills due this window:</strong> $${money(billsThisCheck)}<br>
        <strong>Debt minimums due this window:</strong> $${money(minsThisCheck)}<br>
        <strong>Spending money this paycheck:</strong> $${money(spendingPerCheck)}<br>
        <strong>Extra available this paycheck:</strong> $${money(extra)}<br>
        <strong>Focus:</strong> ${focusLabel}<br>
        <strong>Strategy:</strong> ${strategyLabel}<br><br>

        <strong>Extra split:</strong> $${money(allocation.debtExtra)} to debt ‚Ä¢ $${money(allocation.savingsExtra)} to savings<br><br>

        <strong>Bills to pay now:</strong><br>
        ${billsListHtml}<br><br>

        <strong>Minimum payments due this paycheck:</strong><br>
        ${minsListHtml}<br><br>

        <strong>Extra debt payments this paycheck:</strong><br>
        ${debtExtraListHtml}<br><br>

        <strong>Savings contributions this paycheck:</strong><br>
        ${savingsAllocListHtml}<br><br>

        üëâ After paying these bills and setting aside your spending money,
        send the extra to debt and savings as shown above.<br>
        üí∞ Estimated bank balance after doing this: $${money(endBalance)} (your buffer).<br><br>
        ${planGridHtml}
        <div style="margin-top:14px;">
          <strong>Monthly projection</strong>
          <div class="muted" style="margin-top:6px;">Debt-free date: ${debtFreeText}</div>
          ${projection?.goals?.length ? projection.goals.map(goal => `<div class="muted">${goal.name}: ${goal.completedDate ? formatMonthYear(goal.completedDate) : "Not reached yet"}</div>`).join("") : ""}
          <div class="muted" style="margin-top:6px;">${projectionNote}</div>
        </div>
      `;
    }

    // =========================
    // Events
    // =========================
    document.getElementById("next-button").addEventListener("click", saveIncome);
    document.getElementById("add-bill-button").addEventListener("click", addBill);
    document.getElementById("add-debt-button").addEventListener("click", addDebt);
    document.getElementById("add-goal-button").addEventListener("click", addSavingsGoal);
    document.getElementById("calc-button").addEventListener("click", calculatePlanUI);
    document.getElementById("export-button").addEventListener("click", () => {
      const proUnlocked = getStorage().getItem("bdPro") === "yes";
      if (!proUnlocked) {
        openPaywall();
        return;
      }
      window.print();
    });
    document.getElementById("share-button").addEventListener("click", async () => {
      setShareFeedback("");
      trackEvent("share_clicked", { surface: "planner" });

      const proUnlocked = getStorage().getItem("bdPro") === "yes";
      if (!proUnlocked) {
        openPaywall();
        return;
      }
      if (!lastPlanSummary) {
        setShareFeedback("Calculate your plan first to share it.");
        return;
      }

      const shareData = {
        title: "Budget Dad Plan Summary",
        text: lastPlanSummary.text,
        url: lastPlanSummary.url
      };

      if (navigator.share) {
        try {
          await navigator.share(shareData);
          trackEvent("share_completed", { method: "web_share" });
          setShareFeedback("Share sheet opened.");
          return;
        } catch (err) {
          if (err && err.name === "AbortError") {
            setShareFeedback("Share canceled.");
            return;
          }
        }
      }

      const fallbackText = `${lastPlanSummary.text} ${lastPlanSummary.url}`.trim();
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(fallbackText);
          setShareFeedback("Copied plan summary to clipboard.");
        } else {
          window.prompt("Copy this plan summary:", fallbackText);
          setShareFeedback("Copy the plan summary from the prompt.");
        }
        trackEvent("share_completed", { method: "clipboard" });
      } catch (err) {
        setShareFeedback("Unable to share automatically. You can copy the plan summary from the Plan Output box.");
      }
    });
    document.getElementById("onboarding-button").addEventListener("click", openOnboarding);
    document.getElementById("clear-button").addEventListener("click", () => {
      const ok = confirm("Clear all saved income, bills, and debts?");
      if (!ok) return;
      window.localStorage.removeItem("incomeData");
      window.localStorage.removeItem("billsData");
      window.localStorage.removeItem("debtsData");
      window.localStorage.removeItem("savingsGoalsData");
      window.localStorage.removeItem("debtStrategy");
      window.localStorage.removeItem("focusMode");
      window.sessionStorage.removeItem("incomeData");
      window.sessionStorage.removeItem("billsData");
      window.sessionStorage.removeItem("debtsData");
      window.sessionStorage.removeItem("savingsGoalsData");
      window.sessionStorage.removeItem("debtStrategy");
      window.sessionStorage.removeItem("focusMode");
      window.location.reload();
    });
    document.getElementById("remember-data").addEventListener("change", () => {
      syncStoragePreference();
      loadIncome();
      loadBills();
      loadDebts();
      loadSavingsGoals();
      setFocusModeUI(loadFocusMode() || "balanced");
      refreshNetPreview();
    });

    document.getElementById("onboard-back").addEventListener("click", () => {
      setOnboardStep(onboardStepIndex - 1);
    });
    document.getElementById("onboard-next").addEventListener("click", () => {
      const last = document.querySelectorAll(".onboard-step-page").length - 1;
      if (onboardStepIndex >= last) {
        applyOnboarding();
        window.localStorage.setItem("onboardingDone", "yes");
        closeOnboarding();
        document.getElementById("step1-title").scrollIntoView({ behavior: "smooth", block: "start" });
        return;
      }
      setOnboardStep(onboardStepIndex + 1);
    });
    document.getElementById("onboard-skip").addEventListener("click", () => {
      window.localStorage.setItem("onboardingDone", "yes");
      closeOnboarding();
    });
    document.getElementById("onboard-modal").addEventListener("click", (event) => {
      if (event.target.id === "onboard-modal") {
        closeOnboarding();
      }
    });
    document.getElementById("paywall-modal").addEventListener("click", (event) => {
      if (event.target.id === "paywall-modal") {
        closePaywall();
      }
    });

    // Step 1 UI events
    document.getElementById("pay-frequency").addEventListener("change", updatePayTypeUI);
    document.getElementById("pay-type-hourly").addEventListener("change", updatePayTypeUI);
    document.getElementById("pay-type-salary").addEventListener("change", updatePayTypeUI);
    document.getElementById("debt-strategy").addEventListener("change", () => {
      saveDebtStrategy();
      calculatePlanUI();
    });
    document.getElementById("goal-type").addEventListener("change", updateGoalTypeUI);
    document.querySelectorAll('input[name="focus-mode"]').forEach(input => {
      input.addEventListener("change", () => {
        const mode = getFocusMode();
        saveFocusMode(mode);
        updateFocusToggleStyles();
        calculatePlanUI();
      });
    });

    document.getElementById("ot-enabled").addEventListener("change", updatePayTypeUI);
    document.getElementById("tax-estimate").addEventListener("change", updatePayTypeUI);
    document.getElementById("tax-exact").addEventListener("change", updatePayTypeUI);

    // live net preview updates
    const liveIds = [
      "hourly-rate", "hours-week-1", "hours-week-1-bi", "hours-week-2-bi",
      "ot-threshold", "ot-multiplier", "extra-pay", "tax-rate", "exact-net"
    ];
    liveIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", refreshNetPreview);
    });

    // Load on start
    window.addEventListener("load", () => {
      initStoragePreference();
      loadIncome();
      loadBills();
      loadDebts();
      loadSavingsGoals();
      lockPremiumActions(true);
      updatePayTypeUI();
      refreshNetPreview();
      updateGoalTypeUI();
      setFocusModeUI(loadFocusMode() || "balanced");
      const savedStrategy = loadDebtStrategy();
      if (savedStrategy) {
        document.getElementById("debt-strategy").value = savedStrategy;
      }
      if (window.localStorage.getItem("onboardingDone") !== "yes") {
        setTimeout(openOnboarding, 500);
      }
      const params = new URLSearchParams(window.location.search);
      if (params.get("paywall") === "1") {
        setTimeout(openPaywall, 200);
      }
    });
  </script>
</body>
</html>
